#+TITLE: System Interface implementation for translators
#+AUTHOR: VLEAD
#+SETUPFILE: ../../org-templates/level-2.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil

* Introduction
  System Interface is the glue between the =rest= and =system=.  The world of
  =rest= uses =json= and the world of =system= uses objects. System Interface
  allows these two worlds to talk to each other.

* The =System Interface= class

** Constructor
#+NAME: class_system_interface
#+BEGIN_SRC python
class SystemInterface():

    # Should not create an instance of system interface
    def __init__(self):
        pass

#+END_SRC

** Methods

#+NAME: methods_system_interface
#+BEGIN_SRC python
    @staticmethod
    def create_experiment(experiment_dict, content_type):
        user = System.get_user()
        org = System.get_org(user)
        repo_name = experiment_dict['name'].lower().replace(" ", "-") + "-" + experiment_dict['id']
        repo = System.get_repo(org, repo_name)
        if repo is not None:
            SystemInterface.update_experiment(experiment_dict, content_type, repo)
        else:
            System.create_repo(org, repo_name)
            repo = System.get_repo(org, repo_name)
            # add makefile here
            # check makefile contents
            System.create_file(repo, "makefile", "", """#SHELL := /bin/bash
CODE_DIR=build/code
DOCS_DIR=build/docs
PWD=$(shell pwd)
STATUS=0

all:  post-build

init:
    ./init.sh

build: init
    make -f tangle-make -k all

post-build: build
    if [ ! -d "${DOCS_DIR}/simulation/static/img" ]; then mkdir -p ${DOCS_DIR}/simulation/static/img; fi
    if [ ! -d "${DOCS_DIR}/simulation/static/js" ]; then mkdir -p ${DOCS_DIR}/simulation/static/js; fi
    if [ ! -d "${DOCS_DIR}/simulation/static/css" ]; then mkdir -p ${DOCS_DIR}/simulation/static/css; fi
    if [ ! -d "${CODE_DIR}/simulation/static/img" ]; then mkdir -p ${CODE_DIR}/simulation/static/img; fi
    if [ ! -d "${CODE_DIR}/simulation/static/js" ]; then mkdir -p ${CODE_DIR}/simulation/static/js; fi
    if [ ! -d "${CODE_DIR}/simulation/static/css" ]; then mkdir -p ${CODE_DIR}/simulation/static/css; fi
    rsync -a ${DOCS_DIR}/simulation/static/img/ ${CODE_DIR}/simulation/static/img/
    rsync -a ${DOCS_DIR}/simulation/static/js/ ${CODE_DIR}/simulation/static/js/
    rsync -a ${DOCS_DIR}/simulation/static/css/ ${CODE_DIR}/simulation/static/css/

clean:
    make -f tangle-make clean""")
            System.create_file(repo, "init.sh", "", """#!/bin/bash

if [ -d literate-tools ]; then
    echo "literate-tools already present"
    (cd literate-tools; git checkout readtheorg; git pull)
else
    (git clone https://github.com/vlead/literate-tools.git; cd literate-tools; git checkout readtheorg)
fi

if [ -L tangle-make ]; then
    echo "symlinked makefile already present"
else
    ln -sf literate-tools/makefile tangle-make
fi""")
            System.create_file(repo, "README.org", "", "* Overview\n" + experiment_dict['overview'] + """
* Simulation
+ Use the directory =src/simulation= for the simulation files.
+ Add a directory =static= in =src/simulation= for all the static files.
+ The =static= directory must have three directories =img=, =js=, =css= for the respective files.

* NOTE
+ Please stick to the naming conventions, to build the resources without any error.""")
            # add the specification file
            System.create_file(repo, "simulation-" + experiment_dict['id'] + "." + content_type, "/src/simulation")
            for section in experiment_dict['sections']:
                if section.lower() is not "simulation" and section.lower() is not "experiment":
                    System.create_file(repo, section.lower().replace(" ", "-") + "-" + experiment_dict['id'] + "." + content_type, "/src")

    @staticmethod
    def update_experiment(experiment_dict, content_type, repo):
        filenames_spec = experiment_dict['sections']
        for i in range(len(filenames_spec)):
            filenames_spec[i] = filenames_spec[i].lower().replace(" ", "-") + "-" + experiment_dict['id'] + "." + content_type 
        files = System.get_file(repo, '/src')
        filenames_repo = []
        for file in files:
            filenames_repo.append(file.name)
        add = []
        for filename_spec in filenames_spec:
            if filename_spec not in filenames_repo:
                add.append(filename_spec)
        delete = []
        for filename_repo in filenames_repo:
            if filename_repo not in filenames_spec:
                delete.append(filename_repo)
        for section in add:
            System.create_file(repo, section, "/src")
        for section in delete:
            sha = repo.get_contents("/src/"+section).sha
            System.delete_file(repo, section, "/src", sha)

    @staticmethod
    def create_openedx_lab(labname, data_json):
        # Should be modified if the name can't be unique
        filename = Config.LABSPEC
        
        System.gen_lab_dir(labname)
        System.gen_json_file(data_json, Config.LABPATH + "/" + labname + "/" + filename)
        System.execute_python(Config.OPENEDX_SCRIPT, [os.path.abspath(Config.LABPATH+"/"+labname)])
        System.pack_lab(labname)
        System.del_lab_dir(labname)

#+END_SRC

** Imports
#+NAME: imports_system_interface
#+BEGIN_SRC python
from runtime.system.system import System
from runtime.config.config import Config
import os

#+END_SRC


* Tangle :boilerplate:
#+BEGIN_SRC python :tangle system_interface.py :eval no :noweb yes
<<imports_system_interface>>
<<class_system_interface>>
<<methods_system_interface>>
#+END_SRC
